#include "stdafx.h"
#include "common.h"
#include "iniConfig.h"
#include "hud/dashboard/dash.h"

int loadAttempts = 0;

char iniTemplate[0x41A] = {
	/* Untitled1 (10/15/2021 12:28:25 AM)
	   StartOffset(h): 00000000, EndOffset(h): 00000419, Length(h): 0000041A */
		0x5B, 0x53, 0x65, 0x74, 0x74, 0x69, 0x6E, 0x67, 0x73, 0x5D, 0x0D, 0x0A,
		0x0D, 0x0A, 0x3B, 0x43, 0x68, 0x6F, 0x6F, 0x73, 0x65, 0x20, 0x74, 0x6F,
		0x20, 0x75, 0x73, 0x65, 0x20, 0x54, 0x65, 0x61, 0x70, 0x6F, 0x74, 0x20,
		0x4C, 0x69, 0x76, 0x65, 0x20, 0x77, 0x69, 0x74, 0x68, 0x20, 0x6F, 0x72,
		0x20, 0x77, 0x69, 0x74, 0x68, 0x6F, 0x75, 0x74, 0x20, 0x61, 0x20, 0x4B,
		0x56, 0x2E, 0x20, 0x45, 0x6E, 0x61, 0x62, 0x6C, 0x69, 0x6E, 0x67, 0x20,
		0x74, 0x68, 0x69, 0x73, 0x20, 0x66, 0x65, 0x61, 0x74, 0x75, 0x72, 0x65,
		0x20, 0x77, 0x69, 0x6C, 0x6C, 0x20, 0x6F, 0x76, 0x65, 0x72, 0x77, 0x72,
		0x69, 0x74, 0x65, 0x20, 0x27, 0x55, 0x73, 0x65, 0x4E, 0x61, 0x6E, 0x64,
		0x4B, 0x56, 0x27, 0x2E, 0x0D, 0x0A, 0x4E, 0x6F, 0x4B, 0x56, 0x4D, 0x6F,
		0x64, 0x65, 0x20, 0x3D, 0x20, 0x74, 0x72, 0x75, 0x65, 0x0D, 0x0A, 0x0D,
		0x0A, 0x3B, 0x55, 0x73, 0x65, 0x4E, 0x61, 0x6E, 0x64, 0x4B, 0x56, 0x20,
		0x69, 0x73, 0x20, 0x6F, 0x6E, 0x6C, 0x79, 0x20, 0x65, 0x66, 0x66, 0x65,
		0x63, 0x74, 0x69, 0x76, 0x65, 0x20, 0x69, 0x66, 0x20, 0x6E, 0x6F, 0x20,
		0x4B, 0x56, 0x2E, 0x62, 0x69, 0x6E, 0x20, 0x69, 0x73, 0x20, 0x66, 0x6F,
		0x75, 0x6E, 0x64, 0x20, 0x70, 0x72, 0x65, 0x73, 0x65, 0x6E, 0x74, 0x20,
		0x6F, 0x6E, 0x20, 0x79, 0x6F, 0x75, 0x72, 0x20, 0x68, 0x61, 0x72, 0x64,
		0x20, 0x64, 0x72, 0x69, 0x76, 0x65, 0x20, 0x26, 0x20, 0x4E, 0x6F, 0x4B,
		0x56, 0x4D, 0x6F, 0x64, 0x65, 0x20, 0x69, 0x73, 0x20, 0x64, 0x69, 0x73,
		0x61, 0x62, 0x6C, 0x65, 0x64, 0x2E, 0x0D, 0x0A, 0x55, 0x73, 0x65, 0x4E,
		0x61, 0x6E, 0x64, 0x4B, 0x56, 0x20, 0x3D, 0x20, 0x74, 0x72, 0x75, 0x65,
		0x0D, 0x0A, 0x0D, 0x0A, 0x3B, 0x43, 0x68, 0x6F, 0x6F, 0x73, 0x65, 0x20,
		0x74, 0x6F, 0x20, 0x65, 0x6E, 0x61, 0x62, 0x6C, 0x65, 0x20, 0x6F, 0x72,
		0x20, 0x64, 0x69, 0x73, 0x61, 0x62, 0x6C, 0x65, 0x20, 0x74, 0x68, 0x65,
		0x20, 0x54, 0x65, 0x61, 0x70, 0x6F, 0x74, 0x20, 0x45, 0x6E, 0x67, 0x69,
		0x6E, 0x65, 0x20, 0x67, 0x6C, 0x6F, 0x62, 0x61, 0x6C, 0x6C, 0x79, 0x2E,
		0x0D, 0x0A, 0x54, 0x65, 0x61, 0x70, 0x6F, 0x74, 0x45, 0x6E, 0x67, 0x69,
		0x6E, 0x65, 0x20, 0x3D, 0x20, 0x74, 0x72, 0x75, 0x65, 0x0D, 0x0A, 0x0D,
		0x0A, 0x3B, 0x43, 0x68, 0x6F, 0x6F, 0x73, 0x65, 0x20, 0x74, 0x6F, 0x20,
		0x65, 0x6E, 0x61, 0x62, 0x6C, 0x65, 0x20, 0x6F, 0x72, 0x20, 0x64, 0x69,
		0x73, 0x61, 0x62, 0x6C, 0x65, 0x20, 0x74, 0x68, 0x65, 0x20, 0x54, 0x65,
		0x61, 0x70, 0x6F, 0x74, 0x20, 0x4C, 0x69, 0x76, 0x65, 0x20, 0x48, 0x55,
		0x44, 0x20, 0x67, 0x6C, 0x6F, 0x62, 0x61, 0x6C, 0x6C, 0x79, 0x2E, 0x0D,
		0x0A, 0x43, 0x75, 0x73, 0x74, 0x6F, 0x6D, 0x55, 0x49, 0x20, 0x3D, 0x20,
		0x74, 0x72, 0x75, 0x65, 0x0D, 0x0A, 0x0D, 0x0A, 0x3B, 0x43, 0x68, 0x6F,
		0x6F, 0x73, 0x65, 0x20, 0x74, 0x6F, 0x20, 0x75, 0x73, 0x65, 0x20, 0x54,
		0x65, 0x61, 0x70, 0x6F, 0x74, 0x20, 0x4C, 0x69, 0x76, 0x65, 0x20, 0x6F,
		0x66, 0x66, 0x6C, 0x69, 0x6E, 0x65, 0x20, 0x28, 0x79, 0x6F, 0x75, 0x20,
		0x77, 0x69, 0x6C, 0x6C, 0x20, 0x6E, 0x6F, 0x74, 0x20, 0x62, 0x65, 0x20,
		0x63, 0x6F, 0x6E, 0x6E, 0x65, 0x63, 0x74, 0x65, 0x64, 0x20, 0x74, 0x6F,
		0x20, 0x58, 0x42, 0x4C, 0x29, 0x20, 0x2D, 0x20, 0x74, 0x68, 0x69, 0x73,
		0x20, 0x63, 0x61, 0x6E, 0x20, 0x62, 0x65, 0x20, 0x67, 0x6F, 0x6F, 0x64,
		0x20, 0x69, 0x66, 0x20, 0x79, 0x6F, 0x75, 0x20, 0x61, 0x72, 0x65, 0x20,
		0x74, 0x72, 0x79, 0x69, 0x6E, 0x67, 0x20, 0x74, 0x6F, 0x20, 0x73, 0x61,
		0x76, 0x65, 0x20, 0x79, 0x6F, 0x75, 0x72, 0x20, 0x72, 0x65, 0x6D, 0x61,
		0x69, 0x6E, 0x69, 0x6E, 0x67, 0x20, 0x64, 0x61, 0x79, 0x73, 0x2E, 0x0D,
		0x0A, 0x4F, 0x66, 0x66, 0x6C, 0x69, 0x6E, 0x65, 0x20, 0x3D, 0x20, 0x66,
		0x61, 0x6C, 0x73, 0x65, 0x0D, 0x0A, 0x0D, 0x0A, 0x3B, 0x54, 0x68, 0x69,
		0x73, 0x20, 0x6F, 0x70, 0x74, 0x69, 0x6F, 0x6E, 0x20, 0x70, 0x72, 0x6F,
		0x74, 0x65, 0x63, 0x74, 0x73, 0x20, 0x79, 0x6F, 0x75, 0x72, 0x20, 0x4B,
		0x56, 0x20, 0x61, 0x67, 0x61, 0x69, 0x6E, 0x73, 0x74, 0x20, 0x72, 0x65,
		0x61, 0x64, 0x2F, 0x77, 0x72, 0x69, 0x74, 0x65, 0x20, 0x61, 0x74, 0x74,
		0x65, 0x6D, 0x70, 0x74, 0x73, 0x20, 0x62, 0x79, 0x20, 0x73, 0x70, 0x6F,
		0x6F, 0x6B, 0x79, 0x20, 0x70, 0x65, 0x6F, 0x70, 0x6C, 0x65, 0x2F, 0x74,
		0x6F, 0x6F, 0x6C, 0x73, 0x2E, 0x0D, 0x0A, 0x4B, 0x56, 0x50, 0x72, 0x6F,
		0x74, 0x65, 0x63, 0x74, 0x69, 0x6F, 0x6E, 0x20, 0x3D, 0x20, 0x74, 0x72,
		0x75, 0x65, 0x0D, 0x0A, 0x0D, 0x0A, 0x3B, 0x46, 0x61, 0x6E, 0x73, 0x70,
		0x65, 0x65, 0x64, 0x20, 0x28, 0x32, 0x35, 0x2D, 0x31, 0x30, 0x30, 0x29,
		0x20, 0x56, 0x61, 0x6C, 0x75, 0x65, 0x73, 0x20, 0x65, 0x78, 0x63, 0x65,
		0x65, 0x64, 0x69, 0x6E, 0x67, 0x20, 0x27, 0x31, 0x30, 0x30, 0x27, 0x20,
		0x6F, 0x72, 0x20, 0x62, 0x65, 0x6C, 0x6F, 0x77, 0x20, 0x27, 0x32, 0x35,
		0x27, 0x20, 0x77, 0x69, 0x6C, 0x6C, 0x20, 0x62, 0x65, 0x20, 0x69, 0x67,
		0x6E, 0x6F, 0x72, 0x65, 0x64, 0x20, 0x61, 0x6E, 0x64, 0x20, 0x66, 0x61,
		0x6E, 0x20, 0x73, 0x70, 0x65, 0x65, 0x64, 0x73, 0x20, 0x77, 0x69, 0x6C,
		0x6C, 0x20, 0x62, 0x65, 0x20, 0x73, 0x65, 0x74, 0x20, 0x74, 0x6F, 0x20,
		0x64, 0x65, 0x66, 0x61, 0x75, 0x6C, 0x74, 0x2E, 0x0D, 0x0A, 0x46, 0x61,
		0x6E, 0x73, 0x70, 0x65, 0x65, 0x64, 0x20, 0x3D, 0x20, 0x30, 0x0D, 0x0A,
		0x0D, 0x0A, 0x3B, 0x43, 0x68, 0x6F, 0x6F, 0x73, 0x65, 0x20, 0x74, 0x6F,
		0x20, 0x65, 0x6E, 0x61, 0x62, 0x6C, 0x65, 0x20, 0x6F, 0x72, 0x20, 0x64,
		0x69, 0x73, 0x61, 0x62, 0x6C, 0x65, 0x20, 0x74, 0x68, 0x65, 0x20, 0x54,
		0x65, 0x61, 0x70, 0x6F, 0x74, 0x20, 0x4C, 0x69, 0x76, 0x65, 0x20, 0x4D,
		0x77, 0x32, 0x20, 0x4F, 0x6E, 0x20, 0x48, 0x6F, 0x73, 0x74, 0x20, 0x6D,
		0x65, 0x6E, 0x75, 0x2E, 0x0D, 0x0A, 0x4D, 0x77, 0x32, 0x4F, 0x6E, 0x68,
		0x6F, 0x73, 0x74, 0x20, 0x3D, 0x20, 0x74, 0x72, 0x75, 0x65, 0x0D, 0x0A,
		0x0D, 0x0A, 0x3B, 0x43, 0x68, 0x6F, 0x6F, 0x73, 0x65, 0x20, 0x74, 0x6F,
		0x20, 0x65, 0x6E, 0x61, 0x62, 0x6C, 0x65, 0x20, 0x6F, 0x72, 0x20, 0x64,
		0x69, 0x73, 0x61, 0x62, 0x6C, 0x65, 0x20, 0x74, 0x68, 0x65, 0x20, 0x54,
		0x65, 0x61, 0x70, 0x6F, 0x74, 0x20, 0x4C, 0x69, 0x76, 0x65, 0x20, 0x47,
		0x54, 0x41, 0x20, 0x56, 0x20, 0x45, 0x6E, 0x67, 0x69, 0x6E, 0x65, 0x0D,
		0x0A, 0x47, 0x54, 0x41, 0x56, 0x20, 0x3D, 0x20, 0x74, 0x72, 0x75, 0x65,
		0x0D, 0x0A, 0x0D, 0x0A, 0x5B, 0x42, 0x79, 0x70, 0x61, 0x73, 0x73, 0x65,
		0x73, 0x5D, 0x0D, 0x0A, 0x41, 0x64, 0x76, 0x61, 0x6E, 0x63, 0x65, 0x64,
		0x57, 0x61, 0x72, 0x66, 0x61, 0x72, 0x65, 0x20, 0x3D, 0x20, 0x74, 0x72,
		0x75, 0x65, 0x0D, 0x0A, 0x47, 0x68, 0x6F, 0x73, 0x74, 0x73, 0x20, 0x3D,
		0x20, 0x74, 0x72, 0x75, 0x65, 0x0D, 0x0A, 0x42, 0x6F, 0x32, 0x20, 0x3D,
		0x20, 0x74, 0x72, 0x75, 0x65, 0x0D, 0x0A, 0x42, 0x6F, 0x33, 0x20, 0x3D,
		0x20, 0x74, 0x72, 0x75, 0x65, 0x0D, 0x0A, 0x47, 0x54, 0x41, 0x56, 0x20,
		0x3D, 0x20, 0x74, 0x72, 0x75, 0x65
	};




bool dropTemplate() {
	char* file = DRIVE_TEAPOT NAME_SERVER ".ini";

	if(fileExists(file)) DeleteFile(file);
	if(!cWriteFile(file, iniTemplate, sizeof(iniTemplate))) return false;
	return true;
}

bool Config::ModifyINIBoolValue(const char *sub, const char *name, const bool value) {
	CSimpleIniA reader(true, false, true);
	char *file = DRIVE_TEAPOT NAME_SERVER ".ini";
	if (reader.LoadFile(file) >= 0) {
		if(reader.SetBoolValue(sub, name, value) == SI_FILE) return false;
		if (reader.SaveFile(file, false) == SI_FILE) return false;
	}else return false;

	return true;
}

void Config::Apply() {
	dashboard::DoINI();

	CSimpleIniA reader(true, false, true);
	if (reader.LoadFile(DRIVE_TEAPOT NAME_SERVER ".ini") >= 0 && !reader.IsEmpty()) {
		std::string str_settings = getString(STR_INI_SETTINGS);
		std::string str_bypasses = getString(STR_INI_BYPASSES);

		ini::UseNandKV = reader.GetBoolValue(str_settings.cstr, "UseNandKV", false);
		ini::NoKVMode = reader.GetBoolValue(str_settings.cstr, "NoKVMode", false);
		ini::KVProtection = reader.GetBoolValue(str_settings.cstr, "KVProtection", true);
		ini::cheats = reader.GetBoolValue(str_settings.cstr, getString(STR_INI_TEAPOTENGINE).cstr, false);
		ini::customUI = reader.GetBoolValue(str_settings.cstr, getString(STR_INI_CUSTOMUI).cstr, true);
		ini::offline = reader.GetBoolValue(str_settings.cstr, getString(STR_INI_OFFLINE).cstr, false);
		ini::CE_GTAV = reader.GetBoolValue(str_settings.cstr, getString(STR_INI_GTAV).cstr, false);

		ini::BP_AW = reader.GetBoolValue(str_bypasses.cstr, getString(STR_INI_AW).cstr, true);
		ini::BP_GHOSTS = reader.GetBoolValue(str_bypasses.cstr, getString(STR_INI_GHOSTS).cstr, true);
		ini::BP_BO2 = reader.GetBoolValue(str_bypasses.cstr, getString(STR_INI_BO2).cstr, true);
		ini::BP_BO3 = reader.GetBoolValue(str_bypasses.cstr, getString(STR_INI_BO3).cstr, true);
		ini::BP_GTAV = reader.GetBoolValue(str_bypasses.cstr, getString(STR_INI_GTAV).cstr, true);

		long fanSpeed = reader.GetLongValue(str_settings.cstr, getString(STR_INI_FANSPEED).cstr, 0xFF);
		if (fanSpeed != 0xFF) SetFanSpeed(fanSpeed);

#ifdef BUILD_XDK
		sprintf_s(ini::Passport_Email, 0x20, reader.GetValue("Devkit", "Passport_Email", "NoE"));
		sprintf_s(ini::Passport_Password, 0x20, reader.GetValue("Devkit", "Passport_Password", "NoP"));
#endif
	}else {
		debug("[INI] Missing %s - Created!", NAME_SERVER ".ini");
		if (loadAttempts++ <= 2) {
			dropTemplate();
			Apply();
		}else return;
	}
	memset(iniTemplate, 0, sizeof(iniTemplate));
	debug("[INI] Config Applied!");
}